<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEFg3H7spJXUBvjNRc-QRocIHk3Hd6dho",
            authDomain: "lista-de-asistencia-8cfc5.firebaseapp.com",
            projectId: "lista-de-asistencia-8cfc5",
            storageBucket: "lista-de-asistencia-8cfc5.firebasestorage.app",
            messagingSenderId: "276452664903",
            appId: "1:276452664903:web:8b060bdeef2e70852bf362"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Referencias a elementos (con verificación de seguridad)
        const rsvpForm = document.getElementById("rsvpForm");
        const submitRsvpBtn = document.getElementById("submitRsvpBtn");
        const rsvpModal = document.getElementById("rsvpModal");
        const thankYouModal = document.getElementById("thankYouModal");
        const addToGoogleCalendarBtn = document.getElementById("addToGoogleCalendarBtn");
        const addToIcsBtn = document.getElementById("addToIcsBtn");

        // Funciones de Modales
        const closeModal = (modal) => { 
            if(modal) {
                modal.classList.add("opacity-0"); 
                setTimeout(() => modal.classList.add("hidden"), 300); 
            }
        };
        const openModal = (modal) => { 
            if(modal) {
                modal.classList.remove("hidden"); 
                setTimeout(() => modal.classList.remove("opacity-0"), 10); 
            }
        };

        // --- CALENDARIO (Solo si existen los botones) ---
        if (addToGoogleCalendarBtn) {
            addToGoogleCalendarBtn.addEventListener("click", () => {
                const title = encodeURIComponent("Boda de Daniel & Pamela");
                const details = encodeURIComponent("¡Estás invitado a nuestra boda! Recuerda llevar tu pase.");
                const location = encodeURIComponent("Salón 'El Jardín', Prolongacion Jose Maria Morelos 1, Centro, 56530 Ixtapaluca, Méx.");
                const startDate = "20260315T130000"; const endDate = "20260315T220000";
                window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&details=${details}&location=${location}`, '_blank');
            });
        }
        if (addToIcsBtn) {
            addToIcsBtn.addEventListener("click", () => {
                const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Daniel y Pamela//Boda//ES\nBEGIN:VEVENT\nSUMMARY:Boda Daniel y Pamela\nDTSTART:20260315T130000\nDTEND:20260315T220000\nLOCATION:Salón El Jardín\nEND:VEVENT\nEND:VCALENDAR`;
                const link = document.createElement('a'); link.href = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icsContent);
                link.setAttribute('download', 'Boda_Daniel_y_Pamela.ics'); document.body.appendChild(link); link.click();
            });
        }

        // --- CONFIRMACIÓN SEGURA ---
        if (rsvpForm) {
            rsvpForm.addEventListener("submit", async e => {
                e.preventDefault(); 
                
                if(submitRsvpBtn) { 
                    submitRsvpBtn.disabled = true; 
                    submitRsvpBtn.innerText = "Buscando invitación..."; 
                }
                
                const guestNameInput = document.getElementById("guestName").value.toLowerCase().trim();
                
                try {
                    const q = query(collection(db, "lista_invitados"), where("nombre", "==", guestNameInput));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        alert("No encontramos una invitación con ese nombre exacto. Verifica mayúsculas y acentos.");
                        if(submitRsvpBtn) { submitRsvpBtn.disabled = false; submitRsvpBtn.innerText = "Buscar mi Invitación"; }
                        return;
                    }

                    const guestDoc = querySnapshot.docs[0];
                    const guestData = guestDoc.data();
                    const guestId = guestDoc.id;
                    
                    if (guestData.confirmado === true) {
                        alert(`Hola ${guestData.nombre}, ya habías confirmado tu asistencia.`);
                        if(submitRsvpBtn) { submitRsvpBtn.disabled = false; submitRsvpBtn.innerText = "Buscar mi Invitación"; }
                        return;
                    }

                    const confirmedCount = guestData.boletos || 1;
                    await addDoc(collection(db, "invitados_confirmados"), { nombre: guestData.nombre, asistentes: Number(confirmedCount), fecha_confirmacion: serverTimestamp() });
                    const guestRef = doc(db, "lista_invitados", guestId);
                    await updateDoc(guestRef, { confirmado: true });
                    
                    // Cambiar texto y esperar
                    if(submitRsvpBtn) submitRsvpBtn.innerText = "Espera la descarga...";
                    
                    const nombreParaPDF = guestData.nombre.replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());
                    
                    // Generar PDF
                    await generateAndDownloadTicket(nombreParaPDF, confirmedCount, guestId); 
                    
                    closeModal(rsvpModal); 
                    openModal(thankYouModal); 
                    rsvpForm.reset();

                } catch (err) { 
                    console.error("Error:", err); 
                    alert("Hubo un error. Revisa tu conexión."); 
                } finally { 
                    // Reactivar botón solo si hubo error grave
                    if(submitRsvpBtn && submitRsvpBtn.innerText !== "Espera la descarga...") { 
                        submitRsvpBtn.disabled = false; 
                        submitRsvpBtn.innerText = "Buscar mi Invitación"; 
                    }
                }
            });
        }

        // GENERAR PDF
        window.generateAndDownloadTicket = async function(guestName, guestCount, guestId) {
            // Asegurarnos de que el canvas existe o crearlo
            let canvas = document.getElementById('barcodeCanvas');
            if (!canvas) {
                canvas = document.createElement("canvas");
                canvas.id = 'barcodeCanvas';
            }

            const barcodeValue = guestId.substring(0, 8).toUpperCase();
            JsBarcode(canvas, barcodeValue, { 
                format: "CODE128", displayValue: true, lineColor: "#000", 
                width: 2, height: 50, margin: 0, fontSize: 14, background: "#ffffff" 
            });
            const barcodeImg = canvas.toDataURL("image/png");

            // Cargar imagen del boleto
            const img = new Image();
            img.src = "plantilla-boleto.png"; // Asegúrate que este archivo exista
            
            return new Promise((resolve, reject) => {
                img.onload = function() {
                    const doc = new window.jspdf.jsPDF({ orientation: "portrait", unit: "px", format: [600, 850] });
                    doc.addImage(img, "PNG", 0, 0, 600, 850);

                    doc.setTextColor(255, 255, 255); 
                    doc.setFont("times", "italic"); doc.setFontSize(32); 
                    doc.text(guestName, 300, 550, { align: "center" }); 

                    doc.setFont("helvetica", "bold"); doc.setFontSize(40); 
                    doc.text(`${guestCount}`, 370, 560, { align: "center" }); 

                    doc.addImage(barcodeImg, "PNG", 40, 760, 140, 50); 

                    doc.save(`Pase_Boda_Daniel_y_Pamela_${guestName.replace(/ /g, "_")}.pdf`);
                    resolve();
                };
                img.onerror = function() {
                    alert("Error al cargar la imagen del boleto. Verifica que 'plantilla-boleto.png' existe.");
                    reject();
                };
            });
        }
    </script>
